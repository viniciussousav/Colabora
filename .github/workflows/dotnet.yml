name: build and test

on:
  push:
  pull_request:
    branches: [ main ]
    paths:
    - '**.cs'
    - '**.csproj'

env:
  DOTNET_VERSION: '6.0.408' # The .NET SDK version to use

jobs:
  
  build-and-test:

    - name: Build and Test
      runs-on: ubuntu-latest
      steps:
      - uses: actions/checkout@v3
      
      - name: Setup .NET Core
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}
      
      - name: Install dependencies
        run: dotnet restore
      
      - name: Build
        run: dotnet build --configuration Release --no-restore
      
      - name: Run Unit Test
        run: dotnet test --filter FullyQualifiedName~Colabora.UnitTests --no-restore --verbosity normal
        
  deploy-hml:
    - name: Deploy HML
      runs-on: ubuntu-latest
      needs: [ build-and-test ]
      steps:
        - uses: actions/checkout@v3

        - name: Setup .NET Core
          uses: actions/setup-dotnet@v3
          with:
            dotnet-version: ${{ env.DOTNET_VERSION }}

        - name: Install dependencies
          run: dotnet restore

        - name: Build
          run: dotnet build --configuration Release --no-restore
        
        - name: Publish
          run: dotnet publish -c Release -o '${{ github.workspace }}/out'
        
        - name: Zip Package
          run: |
            cd ${{ github.workspace }}/out
            zip -r ${{ github.workspace }}/out.zip *
        
        - name: Publish to AWS Beanstalk
          uses: einaregilsson/beanstalk-deploy@v21
          with:
            aws_access_key: ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws_secret_key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            application_name: Colabora
            environment_name: colabora-hml
            version_label: 00001
            region: sa-east-1
            deployment_package: deploy.zip
